@startuml AirWatch_Sequence_Alerts

!theme cerulean
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Segoe UI
skinparam defaultFontSize 11
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title <b>BI·ªÇU ƒê·ªí TU·∫¶N T·ª∞ - QU·∫¢N L√ù C·∫¢NH B√ÅO AQI</b>\n<i>Sequence Diagram - AQI Alert Settings</i>

actor "Ng∆∞·ªùi d√πng\n(User)" as User #LightBlue
participant "Tr√¨nh duy·ªát\n(Browser/PWA)" as Browser #LightGreen
participant "FastAPI\nServer" as API #RoyalBlue
participant "AuthService" as Auth #Orange
database "PostgreSQL\n(Users DB)" as DB #LightYellow

== T·∫†O C·∫¢NH B√ÅO M·ªöI ==

User -> Browser: Thi·∫øt l·∫≠p c·∫£nh b√°o AQI
activate Browser

Browser -> Browser: Ch·ªçn v·ªã tr√≠ v√† ng∆∞·ª°ng AQI\n(v√≠ d·ª•: threshold = 100)

Browser -> API: POST /api/user/alerts\nHeader: Authorization: Bearer <token>\n{name, lat, lng, threshold}
activate API

API -> Auth: require_auth(token)
activate Auth
Auth -> Auth: Validate JWT
Auth --> API: Current User
deactivate Auth

API -> API: Validate v·ªõi\nAlertCreate schema

API -> DB: INSERT INTO alert_settings\n(user_id, name, lat, lng, threshold, enabled=true)
activate DB
DB --> API: New AlertSetting
deactivate DB

API --> Browser: 200 OK\n{id, name, lat, lng, threshold, enabled, created_at}

deactivate API

Browser --> User: "ƒê√£ t·∫°o c·∫£nh b√°o th√†nh c√¥ng"

deactivate Browser

== XEM DANH S√ÅCH C·∫¢NH B√ÅO ==

User -> Browser: M·ªü trang "C·∫£nh b√°o"
activate Browser

Browser -> API: GET /api/user/alerts\nHeader: Authorization: Bearer <token>
activate API

API -> Auth: require_auth(token)
activate Auth
Auth --> API: Current User
deactivate Auth

API -> DB: SELECT * FROM alert_settings\nWHERE user_id = {user.id}\nORDER BY created_at DESC
activate DB
DB --> API: List[AlertSetting]
deactivate DB

API --> Browser: JSON Array:\n[{id, name, lat, lng, threshold, enabled}]
deactivate API

Browser --> User: Hi·ªÉn th·ªã danh s√°ch c·∫£nh b√°o

deactivate Browser

== X√ìA C·∫¢NH B√ÅO ==

User -> Browser: Click "X√≥a c·∫£nh b√°o"
activate Browser

Browser -> API: DELETE /api/user/alerts/{alert_id}\nHeader: Authorization: Bearer <token>
activate API

API -> Auth: require_auth(token)
activate Auth
Auth --> API: Current User
deactivate Auth

API -> DB: SELECT * FROM alert_settings\nWHERE id=? AND user_id=?
activate DB
DB --> API: Alert ho·∫∑c null
deactivate DB

alt Kh√¥ng t√¨m th·∫•y
    API --> Browser: 404 Not Found
    Browser --> User: Hi·ªÉn th·ªã l·ªói
else T√¨m th·∫•y
    API -> DB: DELETE FROM alert_settings\nWHERE id=?
    activate DB
    DB --> API: Deleted
    deactivate DB
    
    API --> Browser: 200 OK\n"ƒê√£ x√≥a c·∫£nh b√°o"
    Browser --> User: C·∫£nh b√°o ƒë√£ ƒë∆∞·ª£c x√≥a
end

deactivate API
deactivate Browser

== KI·ªÇM TRA V√Ä G·ª¨I C·∫¢NH B√ÅO ==

participant "Crawler\nService" as Crawler #LightGreen

note over Crawler: Ch·∫°y background\nm·ªói 5 ph√∫t

Crawler -> DB: L·∫•y AQI m·ªõi nh·∫•t c√°c tr·∫°m
activate DB
DB --> Crawler: Current AQI data
deactivate DB

Crawler -> DB: SELECT * FROM alert_settings\nWHERE enabled = true
activate DB
DB --> Crawler: Active alerts
deactivate DB

loop V·ªõi m·ªói alert setting
    Crawler -> Crawler: T√≠nh AQI t·∫°i v·ªã tr√≠ alert\n(IDW interpolation)
    
    alt AQI >= threshold
        Crawler -> DB: INSERT INTO alerts\n(station_uid, alert_type='USER_ALERT',\nmessage, aqi_value)
        activate DB
        DB --> Crawler: Alert logged
        deactivate DB
        
        Crawler -> Browser: Push Notification\n(n·∫øu Service Worker active)
        Browser --> User: üîî "AQI v∆∞·ª£t ng∆∞·ª°ng!"
    end
end

@enduml
